<!--
'use strict';
var fs = require('fs');
var path = require('path');

// http://stackoverflow.com/a/38897674/1414809
function fileSizeSI(size) {
  var e = (Math.log(size) / Math.log(1e3)) | 0;
  return Math.floor(size / Math.pow(1e3, e)) + ('kMGTPEZY'[e - 1] || '') + 'B';
}

var contentTypes = {
  html: 'text/html',
  htm: 'text/html',
  js: 'text/javascript',
  css: 'text/css',
  txt: 'text/plain',
  png: 'image/png',
  bmp: 'image/bmp',
  gif: 'image/gif',
  jpg: 'image/jpeg',
  jpeg: 'image/jpeg',
  mp3: 'audio/mpeg',
  mp4: 'video/mp4',
  mpeg: 'video/mpeg',
  avi: 'video/avi',
  mkv: 'video/webm',
  webm: 'video/webm',
  pdf: 'application/pdf',
  svg: 'image/svg+xml'
};

require('http').createServer(function (req, res) {
  // wipe all ., .., and directory separator inside file name
  var fileName = decodeURI(req.url.replace(/[\/\\]/g, '').replace(/^\.+/g, ''));
  if (req.method === 'POST') {
    // aggregate received chunks of file
    var sb = [];
    req.on('data', function (data) {
      sb.push(data);
    });

    req.on('end', function () {
      var data = sb.join('');
      var buffer = new Buffer(data, 'base64');

      fs.writeFile(fileName, buffer, { flag: 'wx' }, function (err) {
        if (err) {
          console.log(err.message);
          res.writeHead(409);
          res.end('HTTP Error 409 Conflict');
        } else {
          res.writeHead(200, 'OK', {
            'Content-Type' : 'text/plain',
            'Access-Control-Allow-Origin': '*'
          });
          res.end('Done');
          console.log('"' + fileName + '" SAVED!');
        }
      });
    });

  } else if (req.method === 'GET') {
    if (fileName === '') {
      fs.readdir('.', function (err, dir) {
        res.end('<head><meta charset="utf-8"></head><h1>' + __dirname + '</h1><hr><pre><table>' + dir
          // no hidden files
          .filter(function (x) { return x.indexOf('.') !== 0; })
          // no directories
          .map(function (x) { return [x, fs.statSync(x)]; })
          .filter(function (x) { return x[1].isFile(); })
          .map(function (x) {
            return '<tr><td><a href="' + x[0] + '">' + x[0] + '</a></td><td>' +
              '&nbsp;&nbsp;&nbsp;' + x[1].mtime.toString().split('(')[0] +
              '&nbsp;&nbsp;</td><td>' +
              fileSizeSI(x[1].size) + '</td></tr>';
          }).join('') + '</table></pre><hr>'
        );
      });
      return;
    }

    var contentType =
      contentTypes[path.extname('./' + fileName).replace(/^./, '')]
        || 'application/octet-stream';

    fs.exists(fileName, function (exists) {
      if (exists) {
        // http://stackoverflow.com/a/28972079/1414809
        var stat = fs.statSync(fileName);
        var total = stat.size;

        if (req.headers.range) {
          var range = req.headers.range;
          var parts = range.replace(/bytes=/, "").split("-");
          var partialstart = parts[0];
          var partialend = parts[1];

          var start = parseInt(partialstart, 10);
          var end = partialend ? parseInt(partialend, 10) : total - 1;
          var chunksize = (end - start) + 1;
          console.log('"' + fileName + '" SERVED! '
            + 'RANGE: ' + start + ' - ' + end + ' = ' + chunksize);

          var file = fs.createReadStream(fileName, { start: start, end: end });
          res.writeHead(206, {
            'Content-Range': 'bytes ' + start + '-' + end + '/' + total,
            'Accept-Ranges': 'bytes',
            'Content-Length': chunksize,
            'Content-Type': contentType,
            'Access-Control-Allow-Origin': '*'
          });
          file.pipe(res);
        } else {
          console.log('"' + fileName + '" SERVED!');
          res.writeHead(200, {
            'Content-Length': total,
            'Content-Type': contentType,
            'Access-Control-Allow-Origin': '*'
          });
          fs.createReadStream(fileName).pipe(res);
        }
      } else {
        console.log('"' + fileName + '" was requested but not found.');
        res.writeHead(404);
        res.end('HTTP 404 File not found');
      }
    });
  } else {
    res.writeHead(405);
    res.end('HTTP Error 405 Method not allowed');
  }
}).listen(9090, '0.0.0.0');

console.log('pad.js is listening on 9090 port of all network interfaces');

/* -->

<h1>pad.js</h1>
<h2>Total fancy webserver to make access of local files and upload new ones from browsers' console easier</h2>

<h3>Setup:</h3>
<pre>curl pad.js.org | node</pre>

<p>You should probably use this instead if you are using Debian/Ubuntu based Linux distribution:</p>
<pre>curl pad.js.org | nodejs</pre>

<p>And try this on Windows:</p>
<pre>powershell -Command "(iwr pad.js.org).Content | node"</pre>

<h3>Show cases:</h3>

<u>download a file from the place the server is ran from:</u>
<pre>
fetch('http://127.0.0.1:9090/a.txt')
  .then(x => x.text())
  .then(x => console.log('File content: ' + x));
</pre>

<u>upload a text file:</u>
<pre>
fetch('http://127.0.0.1:9090/a.txt', { method: 'post', body: btoa('STRING YOU LIKE TO SAVE') })
  .then(x => x.text())
  .then(console.log);
</pre>

<u>upload a base64 encoded file:</u>
<pre>
// Create a canvas, make 200x200 blue rectangle on it, upload its base64 encoded binary
var canvas = document.createElement('canvas'), context = canvas.getContext('2d');
canvas.width = 200; canvas.height = 200; context.fillStyle = 'blue'; context.fillRect(0, 0, 200, 200);
var png = canvas.toDataURL('image/png').replace('data:image/png;base64,', '');

fetch('http://127.0.0.1:9090/a.png', { method: 'post', body: png })
  .then(x => x.text())
  .then(console.log);
</pre>

<em>Note: The API may would be subject of deep changes so please don't rely much on the dynamic downloadable version of it for now.</em>
</p>

<p><a href="https://github.com/ebraminio/pad.js">Source</a></p>

<!-- */
