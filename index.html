<!--
'use strict';
var fs = require('fs');
var os = require('os');

// http://stackoverflow.com/a/38897674/1414809
function fileSizeSI(size) {
  var e = (Math.log(size) / Math.log(1e3)) | 0;
  return Math.floor(size / Math.pow(1e3, e)) + ('kMGTPEZY'[e - 1] || '') + 'B';
}

// http://stackoverflow.com/a/6234804
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// http://stackoverflow.com/a/9756789
function quoteattr(s) {
  return escapeHtml(s).replace(/\r\n/g, '\n').replace(/[\r\n]/g, '\n');
}

// https://gist.github.com/ebraminio/a2e4338ce29d71156ea1703f5aaec4b6
var contentTypes = {
  html: 'text/html', htm: 'text/html', shtml: 'text/html', css: 'text/css',
  xml: 'text/xml', gif: 'image/gif', jpeg: 'image/jpeg', jpg: 'image/jpeg',
  js: 'application/javascript', atom: 'application/atom+xml',
  rss: 'application/rss+xml', mml: 'text/mathml', txt: 'text/plain',
  jad: 'text/vnd.sun.j2me.app-descriptor', wml: 'text/vnd.wap.wml',
  htc: 'text/x-component', png: 'image/png', tif: 'image/tiff',
  tiff: 'image/tiff', wbmp: 'image/vnd.wap.wbmp', ico: 'image/x-icon',
  jng: 'image/x-jng', bmp: 'image/x-ms-bmp', svg: 'image/svg+xml',
  svgz: 'image/svg+xml', webp: 'image/webp',
  woff: 'application/font-woff', jar: 'application/java-archive',
  war: 'application/java-archive', ear: 'application/java-archive',
  json: 'application/json', hqx: 'application/mac-binhex40',
  doc: 'application/msword', pdf: 'application/pdf',
  ps: 'application/postscript', eps: 'application/postscript',
  ai: 'application/postscript', rtf: 'application/rtf',
  m3u8: 'application/vnd.apple.mpegurl', xls: 'application/vnd.ms-excel',
  eot: 'application/vnd.ms-fontobject', ppt: 'application/vnd.ms-powerpoint',
  wmlc: 'application/vnd.wap.wmlc', kml: 'application/vnd.google-earth.kml+xml',
  kmz: 'application/vnd.google-earth.kmz', '7z': 'application/x-7z-compressed',
  cco: 'application/x-cocoa', jardiff: 'application/x-java-archive-diff',
  jnlp: 'application/x-java-jnlp-file', run: 'application/x-makeself',
  pl: 'application/x-perl', pm: 'application/x-perl', prc: 'application/x-pilot',
  pdb: 'application/x-pilot', rar: 'application/x-rar-compressed',
  rpm: 'application/x-redhat-package-manager', sea: 'application/x-sea',
  swf: 'application/x-shockwave-flash', sit: 'application/x-stuffit',
  tcl: 'application/x-tcl', tk: 'application/x-tcl',
  der: 'application/x-x509-ca-cert', pem: 'application/x-x509-ca-cert',
  crt: 'application/x-x509-ca-cert', xpi: 'application/x-xpinstall',
  xhtml: 'application/xhtml+xml', xspf: 'application/xspf+xml',
  zip: 'application/zip', bin: 'application/octet-stream',
  exe: 'application/octet-stream', dll: 'application/octet-stream',
  deb: 'application/x-debian-package', dmg: 'application/octet-stream',
  iso: 'application/octet-stream', img: 'application/octet-stream',
  msi: 'application/octet-stream', msp: 'application/octet-stream',
  msm: 'application/octet-stream',
  docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  pptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
  mid: 'audio/midi', midi: 'audio/midi', kar: 'audio/midi', mp3: 'audio/mpeg',
  ogg: 'audio/ogg', m4a: 'audio/x-m4a',
  ra: 'audio/x-realaudio', '3gpp': 'video/3gpp', '3gp': 'video/3gpp',
  ts: 'video/mp2t', mp4: 'video/mp4', mpeg: 'video/mpeg', mpg: 'video/mpeg',
  mov: 'video/quicktime', webm: 'video/webm', flv: 'video/x-flv',
  m4v: 'video/x-m4v', mng: 'video/x-mng', asx: 'video/x-ms-asf', asf: 'video/x-ms-asf',
  wmv: 'video/x-ms-wmv', avi: 'video/x-msvideo', mkv: 'video/webm', mime: 'www/mime',
  tar: 'application/x-tar', tgz: 'application/x-tar-gz', gz: 'application/x-gzip'
};

var port = +process.argv[2] || 9090;

function hasOption(name) {
  return process.argv.indexOf(name) !== -1;
}

var localOnly = hasOption('--local');
var noInfo = hasOption('--no-info');
var noMime = hasOption('--no-mime');
var noRange = hasOption('--no-range');
var noForcedUtf8 = hasOption('--no-utf8');
var noUpload = hasOption('--no-upload');

if (hasOption('-h') || hasOption('--help')) {
  console.log([
    'Usage: pad [PORT] [OPTION]...',
    '',
    'Options:',
    '      --local      run only on localhost',
    '      --no-info    hide extra info pad.js gives',
    '      --no-mime    don\'t serve add dangerous mime, for more safety',
    '      --no-range   no range (HTTP/206 Partial Content) serving',
    '      --no-utf8    don\'t add utf-8 on text/* mimes',
    '      --no-upload  disable uploads',
    '  -h, --help       display this help and exit',
    '',
    'The PORT argument is an integer and optional, the default value is 9090'
  ].join('\n'));
  process.exit();
}

require('http').createServer(function (req, res) {
  if (noUpload && ['POST', 'PUT', 'DELETE'].indexOf(req.method) !== -1) {
    res.writeHead(405);
    res.end('HTTP Error 405 Method Not Allowed');
  }

  var path = decodeURI(req.url)
    .replace(/^[\/\\]+/, '').replace(/(^|[\/\\])\.\./g, '');
  if (req.method === 'POST') {
    // aggregate received chunks of file
    var bufferArray = [];
    req.on('data', function (data) {
      bufferArray.push(data);
    });

    req.on('end', function () {
      var buffer = Buffer.concat(bufferArray);

      // buffer.indexOf('\r\n\r\n') + 4 but for older nodes, 13 => '\r'
      for (var start = 4; start < buffer.length; ++start)
        if (buffer[start - 2] === 13 && buffer[start - 4] === 13) break;

      // buffer.lastIndexOf('\r\n-') but for older nodes, 13 => '\r', 45 => '-'
      for (var end = buffer.length - 1 - 2; end >= 0; --end)
        if (buffer[end] === 13 && buffer[end + 2] === 45) break;

      fs.writeFile(path, buffer.slice(start, end), { flag: 'wx' }, function (err) {
        if (err) {
          console.log(err.message);
          res.writeHead(409);
          res.end('HTTP Error 409 Conflict, a file with same name exists');
        } else {
          res.writeHead(200, 'OK', {
            'Content-Type' : 'text/plain',
            'Access-Control-Allow-Origin': '*'
          });
          res.end('Done');
          console.log('"' + path + '" SAVED!');
        }
      });
    });
    return;
  }
  if (req.method === 'PUT') {
    fs.mkdir(path, function () {
      res.end();
    });
    return;
  }
  fs.lstat('./' + path, function (err, stat) {
    if (err) {
      console.log('"' + path + '" was requested but not found.');
      res.writeHead(404);
      res.end('HTTP 404 File not found');
    } else if (stat.isSymbolicLink()) {
      console.log('"' + path + '" a symlink was requested but got denied.');
      res.writeHead(403);
      res.end('HTTP 403 Serving symlink is forbidden, at least for now');
    } else if (stat.isDirectory()) {

      if (!req.url.match(/\/$/)) {
        res.writeHead(302, { 'Location': req.url + '/' });
        res.end();
        return;
      }

      fs.readdir('./' + path, function (err, dir) {
        res.end(['<!DOCTYPE html>', '<html>', '<head>',
          ' <meta charset="utf-8">',
          ' <link rel="icon" href="data:,">',
          ' <style>td:nth-child(3), th:nth-child(3) { text-align: right; } ' +
            'th, td { padding-right: 14px; } th { padding-bottom: 3px; } ' +
            'a, a:active { text-decoration: none; } ' +
            'a:visited { color: #48468F; } ' +
            'a:hover, a:focus { text-decoration: underline; color: red; }</style>',
          '</head>', ' <body style="background-color: #F5F5F5;">',
          (noUpload ? '' : ' <div style="float: right">' +
            '<a onclick="createFolder()" href="#" title="Create a folder">üìÅ</a> ' +
            '<a onclick="noteSubmit()" href="#" title="Create a note">üìù</a> ' +
            '<input type="file" onchange="upload(this.files)" multiple></div>'),
          ' <h2 style="margin-bottom: 12px;">Index of ' +
            ['<a href="/">.</a>'].concat(path.split('/').slice(0, -1).map(function (x, i, arr) {
              return '<a href="/' +
                quoteattr(arr.slice(0, i + 1).join('/')) + '/">' +
                escapeHtml(x) + '</a>';
            })).join('/') + '/</h2>',
          ' <div style="background-color: white; ' +
          'border-top: 1px solid #646464; border-bottom: 1px solid #646464;' +
          'padding-top: 10px; padding-bottom: 14px;">',
          ' <table ellpadding="0" cellspacing="0" style="' +
            'margin-left: 12px; font: 90% monospace; text-align: left;' +
          '"><thead><tr><th onclick="sort(1)">Name‚Üì</th>' +
          '<th onclick="sort(2)">Last Modified:</th>' +
          '<th onclick="sort(3)">Size:</th>' +
          '<th onclick="sort(4)">Type:</th></tr></thead><tbody>' +
          (path === '' ? dir : ['..'].concat(dir))
            .map(function (x) {
              var fileStat = fs.lstatSync('./' + path + x);
              var ext = x.replace(/^.*\.(.*)$/, "$1");
              return {
                name: x.toString(),
                ext: ext,
                size: fileStat.size,
                date: fileStat.mtime.toString().split('(')[0],
                isDir: fileStat.isDirectory()
              };
            })
            .sort(function (x, y) {
              return x.isDir !== y.isDir
                ? (x.isDir < y.isDir ? 1 : -1)
                : (x.name > y.name ? 1 : -1);
            })
            .map(function (x) {
              return '  <tr>\n   <td>' +
                '<a href="' + quoteattr(x.name) + (x.isDir ? '/' : '') + '">' +
                escapeHtml(x.name === '..' ? 'Parent Directory' : x.name) +
                '</a></td>\n   <td title="' + new Date(x.date).getTime() +
                '">' + x.date + '</td>\n   <td title="' + x.size + '">' +
                (x.isDir ? '-' : fileSizeSI(x.size)) + '</td>' +
                '<td>' + (x.isDir ? 'Directory' : contentTypes[x.ext] || '') +
                '</td>\n  </tr>';
            }).join('') + '</tbody></table>',
          ' </div>', ' <div style="' +
          'font: 90% monospace; color: #787878; padding-top: 4px;' +
          '">' + (noInfo ? '' : os.hostname() + ', ' + os.platform() + '/' + os.arch() +
            ', memory: ' + fileSizeSI(os.totalmem()) + ', ') +
            ' pad.js.org, ' +
              (noUpload ? '' : 'supports upload by drag-and-drop and copy-and-paste, ') +
              'your IP is: ' +
              req.connection.remoteAddress + ' ' +
              (req.headers['x-forwarded-for'] || '') + '</div>', ' <script>',
          '"use strict";',
          'function stopEvent(e) { e.stopPropagation(); e.preventDefault(); }',
          'document.addEventListener("dragleave", stopEvent, false);',
          'document.addEventListener("dragover", stopEvent, false);',
          'document.addEventListener("drop", function (e) {',
          '  stopEvent(e);',
          '  handleDataTransfer(e.dataTransfer);',
          '});',
          'document.body.addEventListener("paste", function (e) {',
          '  handleDataTransfer(e.clipboardData);',
          '});',
          'function noteSubmit(text) {',
          '  text = text || prompt("Enter a note:");',
          '  if (!text) return;',
          // fakemime as we split second part for the upload extension which is okay most of the times
          '  upload([new Blob([text], { type: "fakemime/txt" })]);',
          '}',
          'function createFolder() {',
          '  var name = prompt("Enter folder name:");',
          '  if (!name) return;',
          '  fetch(encodeURIComponent(name), { method: "PUT" })',
          '    .then(function (x) { return x.text(); })',
          '    .then(function () { location.reload(); });',
          '}',
          'function handleDataTransfer(dataTransfer) {',
          '  document.body.innerHTML += "<pre style=\'top: 0; right: 0; ' +
              'width: 100%; height: 100%; opacity: .9; position: absolute; ' +
              'background-color: white; text-align: center; padding-top: 10em;' +
              '\'>Uploading&hellip;</pre>";',
          '',
          '  if (dataTransfer.items && dataTransfer.items[0] && dataTransfer.items[0].kind === "string") {',
          '    dataTransfer.items[0].getAsString(noteSubmit);',
          '    return;',
          '  }',
          '  var files = dataTransfer.items',
          '    ? Array.from(dataTransfer.items).map(function (item) { return item.getAsFile(); })',
          '    : dataTransfer.files;',
          '  if (files.length === 0) {', // Needed for Safari, no image yet http://wkb.ug/170449
          '    noteSubmit(dataTransfer.getData("text/plain"));',
          '    return;',
          '  }',
          '  upload(files);',
          '}',
          'function upload(files) {',
          '  document.body.innerHTML += "<pre style=\'top: 0; right: 0; ' +
              'width: 100%; height: 100%; opacity: .9; position: absolute; ' +
              'background-color: white; text-align: center; padding-top: 10em;' +
              '\'>Uploading&hellip;</pre>";',
          '  Array.from(files).map(function (file) {',
          '    return function () {',
          '      return new Promise(function (resolve, reject) {',
          '        var name = file.name;',
          '        if (!name || name === "image.png")', // Firefox uses image.png for clipboard images
          '          name = Date.now() + "." + file.type.split("/")[1];',
          '        var formData = new FormData();',
          '        formData.append("blob", file, "file");',
          '        fetch(encodeURIComponent(name), { method: "POST", body: formData })',
          '          .then(function (x) { return x.text(); })',
          '          .catch(alert).then(resolve);',
          '      });',
          '    };',
          '  }).reduce(function (promise, next) {',
          '    return promise.then(next);',
          '  }, Promise.resolve()).then(function () {',
               // a little delay so users will notice the upload even if it happen so fast
          '    setTimeout(function () { location.reload(); }, 200);',
          '  });',
          '}',
          'var sortState = 1;',
          'function sort(ord) {',
          '  sortState = ord === sortState ? -ord : ord;',
          '  var p = document.getElementsByTagName("tbody")[0];',
          // http://stackoverflow.com/a/39569822
          '  Array.from(p.children)',
          '    .map(function (x) { return p.removeChild(x); })',
          '    .sort(function (x, y) {',
          '      x = x.getElementsByTagName("td");',
          '      y = y.getElementsByTagName("td");',
          '      var xDir = x[3].textContent === "Directory";',
          '      var yDir = y[3].textContent === "Directory";',
          '      if (xDir !== yDir) return xDir < yDir ? 1 : -1;',
          '      if (x[0].textContent === "Parent Directory") return -1;',
          '      if (y[0].textContent === "Parent Directory") return 1;',
          '      if (ord === 2 || ord === 3)',
          '        return +x[ord - 1].title > +y[ord - 1].title ? sortState : -sortState;',
          '      return x[ord - 1].textContent > y[ord - 1].textContent ? sortState : -sortState;',
          '    }).forEach(function (x) { p.appendChild(x); });',
          '  Array.from(document.getElementsByTagName("th")).forEach(function (x, i) {',
          '    x.textContent = x.textContent.replace(/.$/, i === ord - 1',
          '      ? (sortState < 0 ? "‚Üë" : "‚Üì") : ":");',
          '  });',
          '}',
          ' </script>', '</body>', '</html>'
        ].join('\n'));
      });

    } else {

      var contentType = contentTypes[path.replace(/^.*\.(.*)$/, "$1")];

      if ((contentType.indexOf('text/') === 0) && !noForcedUtf8)
        contentType = 'text/plain; charset=utf-8';

      if (contentType === undefined) // fallback mime
        contentType = 'application/octet-stream';

      if (noMime && !/^(audio|video)\//.test(contentType))
        contentType = 'application/octet-stream';

      // http://stackoverflow.com/a/28972079/1414809
      if (req.headers.range && !noRange) {
        var parts = req.headers.range.replace(/bytes=/, "").split("-");

        var start = +parts[0];
        var end = parts[1] ? +parts[1] : stat.size - 1;
        console.log('"' + path + '" SERVED! RANGE: ' +
          start + ' - ' + end);

        res.writeHead(206, {
          'Content-Range': 'bytes ' + start + '-' + end + '/' + stat.size,
          'Accept-Ranges': 'bytes',
          'Content-Length': (end - start) + 1,
          'Content-Type': contentType,
          'Access-Control-Allow-Origin': '*'
        });
        fs.createReadStream(path, { start: start, end: end }).pipe(res);
      } else {
        console.log('"' + path + '" SERVED!');
        res.writeHead(200, {
          'Content-Length': stat.size,
          'Content-Type': contentType,
          'Access-Control-Allow-Origin': '*'
        });
        fs.createReadStream(path).pipe(res);
      }
    }
  });
}).listen(port, localOnly ? '127.0.0.1' : '0.0.0.0');

console.log('pad.js is listening on ' + port +
  ' port of ' + (localOnly ? 'local' : 'all') + ' network interface(s)');
var ifs = os.networkInterfaces();
// http://stackoverflow.com/a/38929214/1414809
console.log('(' + Object.keys(ifs)
  .map(function (x) {
    return [x, ifs[x].filter(function (x) { return x.family === 'IPv4'; })[0]];
  })
  .filter(function (x) { return x[1]; })
  .filter(function (x) { return !localOnly || (x[1].address === '127.0.0.1'); })
  .map(function (x) { return x[0] + ': http://' + x[1].address + ':' + port; })
  .join(', ') + ')');
/* -->
<!DOCTYPE html>
<h1>pad.js</h1>
<h2>Total fancy node.js webserver for transfering files from/to browser console and terminal</h2>

<h3>Setup:</h3>
<pre>curl pad.js.org | node</pre>

<p>You should probably use this instead if you are using Debian/Ubuntu based Linux distribution:</p>
<pre>curl pad.js.org | nodejs</pre>

<p>And try this on Windows:</p>
<pre>powershell -Command "(iwr pad.js.org).Content | node"</pre>

<p>Or this sets it up as a Docker daemon:</p>
<pre>docker run --restart=always -v /files:/files --name pad.js -d -p 9090:9090 quay.io/ebraminio/pad.js</pre>

<p>Use this if you want to have it as a terminal tool:</p>
<pre>npm install -g pad.js
pad [PORT]</pre>

<h3>Show cases:</h3>

<u>download a file from the place the server is ran from:</u>
<pre>
fetch('http://127.0.0.1:9090/a.txt')
  .then(x => x.text())
  .then(x => console.log('File content: ' + x));
</pre>

<u>upload a text file:</u>
<pre>
var formData = new FormData();
formData.append('blob', new Blob(['STRING YOU LIKE TO SAVE']), 'file');
fetch('http://127.0.0.1:9090/a.txt', { method: 'POST', body: formData })
  .then(x => x.text())
  .then(console.log);
</pre>

<u>upload a base64 encoded file:</u>
<pre>
// Create a canvas, make 200x200 blue rectangle on it, upload its base64 encoded binary
var canvas = document.createElement('canvas'), context = canvas.getContext('2d');
canvas.width = 200; canvas.height = 200; context.fillStyle = 'blue'; context.fillRect(0, 0, 200, 200);
canvas.toBlob(function (blob) {
  var formData = new FormData();
  formData.append('blob', blob, 'file');
  fetch('http://127.0.0.1:9090/a.png', { method: 'POST', body: formData })
    .then(x => x.text())
    .then(console.log);
});
</pre>

<u>upload a file from terminal:</u>
<pre>curl -F "file=@a.png" http://127.0.0.1:9090/a.png</pre>

<p><a href="https://github.com/ebraminio/pad.js">Source</a></p>

<!-- */
