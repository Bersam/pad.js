<!--

var fs = require('fs');
var path = require('path');

require('http').createServer(function (req, res) {
  if (req.url.match(/^\/upload(binary|text)\//) && req.method === 'POST') {
    var isBinary = req.url.indexOf('/uploadbinary/') === 0;
    var targetName = req.url.replace(/^\/upload(binary|text)\//, '');

    // wipe all ., .., and directory separator inside file name
    targetName = targetName.replace(/^\.+/g, '').replace(/[\/\\]/g, '');

    // parse a file upload
    var sb = [];
    req.on('data', function (data) {
      sb.push(data);
    });

    req.on('end', function () {
      var data = sb.join('');
      var buffer = new Buffer(data, isBinary ? 'base64' : undefined);

      fs.writeFile(targetName, buffer, { flag: 'wx' }, function (err) {
        if (err) {
          console.log(err);
          res.writeHead(409);
          res.end('HTTP Error 409 Conflict');
          return;
        }
        res.writeHead(200, 'OK', {
          'Content-Type' : 'text/plain',
          'Access-Control-Allow-Origin': '*'
        });
        res.end('Done');
        console.log('"' + targetName + '" SAVED!');
      });
    });

  } else if (req.method === 'GET') {
    var filePath = req.url.replace(/^\.+/g, '').replace(/[\/\\]/g, '');

    if (filePath === '') {
      fs.readdir('.', function (err, dir) {
        res.end('<h1>' + __dirname + '</h1>' + dir
          // no hidden files
          .filter(function (x) { return x.indexOf('.') !== 0; })
          // no directories
          .filter(function (x) { return fs.statSync(x).isFile(); })
          .map(function (x) { return '<a href="' + x + '">' + x + '</a>'; })
          .join('<br>')
        );
      });
      return;
    }

    var ext = path.extname('./' + filePath);
    switch (ext) {
    case '.html':
    case '.htm':
      contentType = 'text/html';
      break;
    case '.js':
      contentType = 'text/javascript';
      break;
    case '.css':
      contentType = 'text/css';
      break;
    case '.txt':
      contentType = 'text/plain';
      break;
    default:
      contentType = 'application/octet-stream';
    }

    fs.exists(filePath, function (exists) {
      if (exists) {
        fs.readFile(filePath, function (error, content) {
          if (error) {
            res.writeHead(500);
            res.end();
          } else {
            res.writeHead(200, {
              'Content-Type' : contentType,
              'Access-Control-Allow-Origin': '*'
            });
            res.end(content, 'utf-8');
            console.log('"' + filePath + '" SERVED!');
          }
        });
      } else {
        res.writeHead(404);
        res.end('HTTP 404 File not found');
      }
    });

  } else {
    console.log('Unknown API request on ' + req.url);
    res.writeHead(405);
    res.end('HTTP Error 405 Method not allowed');
  }
}).listen(9090, '0.0.0.0');

console.log('pad.js is listening on 9090 port of all network interfaces');

/* -->

<h1>pad.js</h1>
<h2>Total fancy webserver to make access of local files and upload new ones from browsers' console easier</h2>

<h3>Setup:</h3>
<pre>curl pad.js.org | node</pre>

<p>You should probably use this instead if you are using Debian/Ubuntu based Linux distribution:</p>
<pre>curl pad.js.org | nodejs</pre>

<p>And try this on Windows:</p>
<pre>@powershell -Command "(iwr pad.js.org).Content | node"</pre>

<h3>Show cases:</h3>

<u>download a file from the place the server is ran from:</u>
<pre>
fetch('http://127.0.0.1:9090/a.txt')
  .then(x => x.text())
  .then(x => console.log('File content: ' + x));
</pre>

<u>upload a text file and store it on /output folder:</u>
<pre>
fetch('http://127.0.0.1:9090/uploadtext/a.txt', { method: 'post', body: 'STRING YOU LIKE TO SAVE' })
  .then(x => x.text())
  .then(console.log);
</pre>

<u>upload a base64 encoded file:</u>
<pre>
// Create a canvas, make 200x200 blue rectangle on it, upload its base64 encoded binary
var canvas = document.createElement('canvas'), context = canvas.getContext('2d');
canvas.width = 200; canvas.height = 200; context.fillStyle = 'blue'; context.fillRect(0, 0, 200, 200);
var png = canvas.toDataURL('image/png').replace('data:image/png;base64,', '');

fetch('http://127.0.0.1:9090/uploadbinary/a.png', { method: 'post', body: png })
  .then(x => x.text())
  .then(console.log);
</pre>

<em>Note: The API may would be subject of deep changes so please don't rely much on the dynamic downloadable version of it for now.</em>
</p>

<p><a href="https://github.com/ebraminio/pad.js">Source</a></p>

<!-- */
